# 実行方法

各処理を実行する為のシェルが用意されている。
シェルには引数としてプロパティーファイルを指定する。

プロパティーファイル内にはJDBC接続の情報（や各処理で必要とする値）が書かれているので、環境に応じて用意する。



## 初期データ作成処理

初期データ作成用のシェルを実行する。

```bash
./initdata.sh プロパティーファイル
```

テーブルは事前にcreateされている前提。

生成するデータ量等はプロパティーファイル内で指定する。

何度でも実行可能。（既存データをtruncateして新しいデータをinsertする）

このシェルは以下のプログラムを実行する。

1. InitialData00CreateTable
   - テーブルを作成する。
2. InitialData01MeasurementMaster
   - measurement.xlsxを読み込み、度量衡マスターにinsertする。
3. InitialData02FactoryMaster
   - 工場マスターのデータを生成する。
4. InitialData03ItemMaster
   - 品目マスター・品目構成マスターのデータを生成する。
5. InitialData04ItemManufacturingMaster
   - 製造品目マスターのデータを生成する。
6. InitialData05CostMaster
   - 原価マスターのデータを生成する。
7. InitialData06ResultTable
   - 結果テーブルをクリアする。

この初期データ作成処理で生成されたデータは、指定された基準日のデータしか整合性が保証されない。
（異なる日付をバッチ処理やオンライン処理で指定しても、正しく動作しない）



## バッチ処理

バッチ用シェルを実行する。

```bash
./exec-batch.sh プロパティーファイル
```

指定された工場の処理が終わると、終了する。

このシェルは以下のプログラムを実行する。

- BenchBatch
  - 第1引数はバッチ基準日（初期データ作成時に指定したものと同じ）
  - 第2引数は処理対象の工場ID。カンマ区切りで複数指定可能。「1-3」のようにハイフンで範囲を指定可能。省略時または「all」は全工場が対象。
  - 第3引数はコミット率。トランザクションに対し、ランダムでコミットするかロールバックする。
    100で常にコミット、0で常にロールバック。省略時は100。



## オンライン処理

オンライン用シェルを実行する。

```bash
./exec-online.sh プロパティーファイル
```

オンライン処理はバッチ処理と並列に実行する想定。

無限に動き続けるので、停止させる場合はCtrl+Cを入力する。（Ctrl+Cが入力されると、各スレッドを正常に終了させ、ログファイルをクローズして終了する）

このシェルは以下のプログラムを実行する。

- BenchOnline
  - 第1引数は実行基準日（バッチの基準日と同じものを指定する）
  - 第2引数はスレッド数。（概ね、工場数と同じ数を指定する想定だが、それ以上でも可）
    - 各スレッドがランダムにタスク（業務）を選択して実行する。これを繰り返す。



# プロパティーの説明

実行時に各処理で使用する値（JDBCの接続先など）をプロパティーとして指定する。

プロパティーは、プロパティーファイルに記述する他に、javaコマンドの引数で指定できる。

- プロパティーファイルで指定する場合、javaコマンドに `-Dproperty="プロパティーファイルのパス"` を指定する。
- 個別に指定する場合、javaコマンドの-Dオプションで指定する。（例 `-Donline.jdbc.type=3` ）



## 共通

初期データ作成処理・バッチ処理・オンライン処理で使用するパラメーター。

- jdbc.url
  - JDBCの接続URL
- jdbc.user, jdbc.password
  - DBに接続するユーザー・パスワード
- tsurugi.endpoint
  - Tsurugiに接続する場合のエンドポイント
- tsurugi.user, tsurugi.password
  - Tsurugiに接続する場合のユーザー・パスワード
- *.jdbc.type
  - JDBC実行に使用するライブラリー
    - 1: Doma2
    - 2: 生JDBC
    - 3: コネクション（トランザクション管理）はDoma2を使用し、SQLの実行は生JDBCを使う方式
    - 4: Tsurugi（Iceaxe）
- decimal.scale
  - BigDecimalの除算時の小数点以下の桁数



## init

初期データ作成処理で使用するパラメーター。

- doc.dir
  - ドキュメント（度量衡マスターのデータ（measurement.xlsx））が置いてある場所
- init.batch.date
  - データを作成する基準日
    - バッチ処理（およびオンライン処理）を実行する際の日付を指定する。その日付の初期データが作成される。
- init.factory.size
  - 工場数（factory_masterに生成するレコード数）
    - バッチ処理は工場毎に分散して処理する想定。
- init.item.product.size
  - 品目マスターの「製品」の数（item_masterに生成するproductのレコード数）
    - 製品は、オンライン処理の新商品追加業務で増えていく。
- init.item.work.size
  - 品目マスターの「中間材」の数（item_masterに生成するwork_in_processのレコード数）
- init.item.material.size
  - 品目マスターの「原料」の数（item_masterに生成するraw_materialのレコード数）
- init.item.manufacturing.size
  - 製造品目数（item_manufacturing_masterに生成するレコード数）
- init.parallelism
  - 初期データ生成処理の並列実行数（最大スレッド数）
    - 省略時はCPU数



※品目構成マスター（item_construction_master）は、品目マスターからランダムに生成するので、レコード数は指定しない。
（品目構成マスターは、オンライン処理の原材料変更業務で増減していく）



## batch

バッチ処理で使用するパラメーター。

- batch.execute.type
  - バッチ処理の実行方式
    - 1: 全工場を直列に実行する（シングルスレッド）
    - 2: 工場毎に並列で実行する（マルチスレッド）



## online

オンライン処理で使用するパラメーター。

- online.log.file
  - オンライン処理が出力するログファイルのパス
    - オンライン処理では、処理したトランザクション数をカウントするのに使う目的で、ログファイルを出力する。
    - オンライン処理はマルチスレッドで処理するので、ログファイルは各スレッドが出力する。このため、ファイル名には `%d` を含める必要がある。（`%d` の部分がスレッド番号に置換される）
- online.task.ratio.タスク名
  - タスク（業務）を実行する割合
    - 百分率ではなく、online.task.ratio.*の全合計に対する値（比率）を指定する。
    - 0にすると、そのタスクは実行されない。
- online.task.sleep.タスク名
  - タスク実行後に一時停止（スリープ）する時間[秒]


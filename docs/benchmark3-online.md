Draft 2023-04-13

### オンライン処理詳細

オンライン処理は、複数のクライアントが並列で実行する。
各処理は、どの工場を対象とするかを毎回ランダムに決定する。

SQLで使用する当日日付は、パラメーターとして渡す。（SQLの日付取得関数を使用しない）
バッチの実行時に指定する当日日付と同じ値とする。

照会系の処理の場合、実行結果はコンソールに出力する。

各処理の処理件数をカウントできるようにする。
処理対象を決定できず処理できなかった場合は、エラー件数にカウントする。

Tsurugiの場合、select for updateによる悲観ロックは使用できない。
また、トランザクション開始時にトランザクションオプションを指定する必要がある。
SQL実行時あるいはコミット時にトランザクションがabortしたら、トランザクションオプションを変更してトランザクションを再実行する。
トランザクションオプションは以下のパターンを選択できるようにする。

- 常にOCC
- 常にLTX（selectのみのトランザクションはRTX）
- 何回かOCCで実行し、LTX（RTX）に切り替える



#### 新規開発商品の追加

1. 品目IDを採番する。
   ```
   select max(品目ID) + 1 from 品目マスター
   ```
   ※品目マスターは1件以上存在する想定（つまり品目IDはnullでない）
   
2. 品目マスターに登録する。
   ```
   insert into 品目マスター values(採番した品目ID, …)
   ```
   
   - 開始日は当日日付とする。（品目IDの重複採番があったら一意制約違反にさせるため）
   - 品目ID・開始日以外の項目は、製品の品目マスターの初期データと同じ。
   
   PKによる一意制約違反が起きたら、ロールバックし、品目IDの採番からやり直す。（他トランザクションによって既に品目IDが登録されている場合を想定）
   
3. 品目構成マスターを登録する。
   1. 初期データ作成時と同様に品目構成マスター（複数）を登録する。
      ```
      insert into 品目構成マスター values(品目ID, 採番した品目ID, …)
      ```

4. コミットする。

5. 製造品目マスターに登録する。

   ```
   insert into 製造品目マスター values(当工場ID, 採番した品目ID, …)
   ```

   - 生産数←ランダム（初期データ作成時と同じ）

6. コミットする。



#### 生産数の変更

1. 品目IDを決める。
   `select 品目ID from 品目マスター where 当日日付 between 開始日 and 終了日 and 品目種類=製品` で品目ID一覧を取得し、その中からランダムに決定する。

2. 生産数を決める。ランダム[0..500]×100

3. 製造品目マスターを更新または登録する。
   
   1. 製造品目マスターを取得する。
      ```
      select * from 製造品目マスター
      where 工場ID=当工場ID and 品目ID=対象品目ID and 当日日付 between 開始日 and 終了日
      ```
      
   2. 製造品目マスターが取得されなかった場合は、製造品目マスターを登録する。
      ```
      insert into 製造品目マスター values(当工場ID, 対象品目ID, 当日日付, 終了日, 新生産数)
      ```
      終了日←製造品目マスターから開始日が未来日付で直近のレコードを取得し、その開始日-1。取得できなかった場合は9999/12/31。
      
      一意制約違反が起きた場合は、製造品目マスターの取得からやり直す。（別トランザクションによって同時にINSERTされた場合を想定）
      
   3. 製造品目マスターが取得できた場合は、製造品目マスターを更新する。
      ```
      update 製造品目マスター
      set 生産数=新生産数
      where 工場ID=当工場ID and 品目ID=対象品目ID and 当日日付 between 開始日 and 終了日
      ```
   
   - insertまたはupdateなので、merge文でも可

4. コミットする。

なお、この処理では製造品目マスターを取得してから更新するので、その間に他トランザクションから更新されないようにしなければならない。
（トランザクション分離レベルがSERIALIZABLEであれば何もする必要は無いが、それ以外の場合は、悲観ロックを使用する（selectにfor updateを付ける））



#### 原材料の変更

1. 原材料の追加か削除をランダムに決める。
   
2. 追加の場合

   1. 品目構成マスターから原材料以外の品目をランダムに選択する。

      ```
      select 品目構成マスター.* from 品目構成マスター m
      left join 品目マスター i on i.品目ID=m.品目ID and 当日日付 between i.開始日 and i.終了日
      where 当日日付 between m.開始日 and m.終了日
      and i.品目種類<>原材料
      ```

      の中から1レコード選択する。

      - 品目構成をキャッシュして、その中から選択してもよいものとする。

   2. 品目構成マスターの対象レコードをロックする。（悲観ロックを使用する場合）

      ```
      select * from 品目構成マスター
      where 品目ID=対象構成の品目ID and 親品目ID=対象構成の親品目ID and 開始日=対象構成の開始日
      for update
      ```

      - 下位構成のinsert時に同じ品目が他スレッドからinsertされないようにする為（下位構成に同一品目が存在しないようにする為）

   3. 追加する原材料をランダムに決める。

      ```
      select * from 品目マスター
      where 当日日付 between 開始日 and 終了日
      and 品目種類=原材料
      ```

      の中から1レコード選択する。

      該当品目構成の下位品目に同一の品目が存在している場合は決定し直す。

      - 品目マスターをキャッシュして、その中から選択してもよいものとする。
      - 追加する原材料が決定できなかった場合は、当処理（原材料の変更）を行わない。

   4. 品目構成マスターに追加する。
      ```
      insert into 品目構成マスター values(/*親品目ID*/決定した品目ID, /*品目ID*/追加する品目ID, …)
      ```

      - 有効日付範囲は追加対象の品目構成の有効日付範囲と同じとする。
      - 原料単位は追加する品目マスターの単位
      - 原料数量はランダム[0.1 .. 10.0]
      - ロス率はランダム（初期データ作成時と同じ）

3. 削除の場合

   1. 品目構成マスターから原材料の品目（削除対象）をランダムに選択する。

      ```
      select 品目構成マスター.* from 品目構成マスター m
      left join 品目マスター i on i.品目ID=m.品目ID and 当日日付 between i.開始日 and i.終了日
      where 当日日付 between m.開始日 and m.終了日
      and i.品目種類=原材料
      ```

      - 品目構成をキャッシュして、その中から選択してもよいものとする。

   2. 品目構成マスターを削除する。

      ```
      delete from 品目構成マスター
      where 品目ID=削除対象の品目ID and 親品目ID=削除対象の親品目ID and 開始日=削除対象の開始日
      ```

4. コミットする。



#### 原価の変更（在庫増加）

1. 処理対象の品目IDを決める。

   1. 品目IDを取得する。

      ```
      select 品目ID from 原価マスター
      where 工場ID=当工場ID
      order by 品目ID
      ```

   で品目ID一覧を取得し、その中からランダムに決定する。

   3. コミットする。

2. 増やす在庫数をランダム[1.0..10.0]×100に決める。

3. 原価マスターから在庫単位を取得する。

   ```
   select * from 原価マスター
   where 工場ID=当工場ID and 品目ID=対象品目ID
   ```

4. 品目マスターを取得し、増やす金額を品目マスター.品目単価×ランダム[0.90 .. 1.10]×増やす在庫数とする。（単位を統一して計算する）

   ```
   select * from 品目マスター
   where 品目ID=対象品目ID and 当日日付 between 開始日 and 終了日
   ```

5. 原価マスターを更新する。
   ```
   update 原価マスター
   set 在庫数量=在庫数量+増やす在庫数, 在庫金額=在庫金額+増やす金額
   where 工場ID=当工場ID and 品目ID=対象品目ID
   ```

6. コミットする。



#### 原価の変更（在庫減少）

1. 処理対象の品目IDを決める。

   1. 品目IDを取得する。

      ```
      select 品目ID from 原価マスター
      where 工場ID=当工場ID
      order by 品目ID
      ```

   で品目ID一覧を取得し、その中からランダムに決定する。

   3. コミットする。

2. 減らす在庫数をランダム[1.0..10.0]×100に決める。

3. 原価マスターから在庫数量を取得する。

   ```
   select * from 原価マスター
   where 工場ID=当工場ID and 品目ID=対象品目ID
   ```

4. 原価マスターを更新する。

   - 在庫数量 - 減らす在庫数 が0以下になる場合、0に更新する。
   （在庫数量は0以上であるという仕様は、DBの制約を使用せず、アプリケーション側で担保する）

      ```
      update 原価マスター
      set 在庫数量=0, 在庫金額=0
      where 工場ID=当工場ID and 品目ID=対象品目ID
      ```

   - それ以外の場合は以下の計算式で更新する。

      ```
      update 原価マスター
      set 在庫数量=在庫数量-減らす在庫数, 在庫金額=在庫金額-在庫金額×減らす在庫数÷在庫数量
      where 工場ID=当工場ID and 品目ID=対象品目ID
      ```

5. コミットする。

なお、この処理では在庫数量を取得してから更新するので、その間に他トランザクションから更新されないようにしなければならない。
（トランザクション分離レベルがSERIALIZABLEであれば何もする必要は無いが、それ以外の場合は、悲観ロックを使用する（selectにfor updateを付ける））



#### 重量の照会

特定品目をselectするパターン。

1. 品目IDを決める。
   `select 品目ID from 製造品目マスター where 工場ID=当工場ID and 当日日付 between 開始日 and 終了日` で品目ID一覧を取得し、その中からランダムに決定する。
   
2. 結果テーブルから取得する。
   
   ```
   select 親品目ID, 品目ID, 重量計, 重量計単位, 重量割合
   from 結果テーブル
   where 工場ID=当工場ID and 日付=当日日付 and 製造品目ID=決定した品目ID
   order by 親品目ID, 品目ID
   ```



#### 所要量の照会

集計してselectするパターン。

1. 結果テーブルから取得する。
   ```
   select 工場ID, 日付, 品目ID, sum(所要量), max(所要量単位)
   from 結果テーブル r
   left join 品目マスター m on m.品目ID=r.品目ID
   where 工場ID=当工場ID and 日付=当日日付 and m.品目種類=原料
   group by 工場ID, 日付, 品目ID
   order by 品目ID
   ```
   ※所要量単位は同一品目であれば同じ（標準単位）になっているはずなので、任意の行の値を使用する。



#### 原価の照会

一覧を取得するパターン。

1. 結果テーブルから取得する。
   ```
   select 工場ID, 日付, 製造品目ID, 総製造原価, 生産数, 製造原価
   from 結果テーブル
   where 工場ID=当工場ID and 日付=当日日付 and 品目ID=製造品目ID
   order by 製造品目ID
   ```
   ※結果テーブルの製造品目レコードでは、結果テーブル.品目IDと結果テーブル.製造品目IDは等しい



### 定期実行バッチ詳細

#### 在庫履歴の作成

1. 在庫テーブルから削除する。
   `delete from 在庫テーブル where 日付=当日日付 and 工場ID=当工場ID`
2. 原価マスターから在庫金額の合計を取得する。
   `select sum(在庫金額) from 原価マスター where 工場ID=当工場ID`
3. 在庫テーブルに登録する。
   `insert into 在庫テーブル values(当日日付, 工場ID, 在庫金額)`
4. コミットする。
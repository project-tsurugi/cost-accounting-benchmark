Draft 2021-09-28



共通定義

- 「ランダム[x .. y]」とは、x以上y以下の範囲の均一な乱数を指す。xとyが小数の場合は、乱数値もその小数点以下の桁数を持つ。
- 値xをランダムにn個に分割する場合は、以下の手順で行う。
  1. xを分割した際に取り得る値の個数（例えば10.0は、0.1～10.0の100通り取り得る）がn以下の場合
     1. 要素数がn個の配列（各要素は初期値0とする）を用意し、xを分割した際に取り得る値の数だけ以下の処理を繰り返す。
        - xの最小桁単位（例えばxが12.3の場合、0.1）を、配列のいずれかの要素にランダムに加算する。
  2. そうでない場合
     1. 0より大きくx未満の範囲でランダムな値をn-1個決定し（値は重複しないようにする）、昇順にr[1]～r[n-1]とする。これらの値を区切りの値とすれば、n個の区画が出来ることになる。
     2. 最初の区画の値はr[1]-0、次の区画はr[2]-r[1]、…、最後の区画はx-r[n-1]という値になる。
- 「単位」を持つ「数量」同士の演算（加算・減算や、比率を算出する場合）は、単位を揃える必要がある。単位が異なる場合は、度量衡マスターを使って数量を標準単位に変換する。
  1. 度量衡マスターから、単位=指定単位のレコードを取得する。
     - 取得できない場合、スケール←1、標準単位←指定単位として扱う。
       - 重量、容量、長さ系では必ず取得できるはず。単位が「個」である場合は取得できない。
  2. 変換後数量 ← 指定数量 × 度量衡マスター.スケール
     変換後単位 ← 度量衡マスター.標準単位
  3. 演算する際に、2つの値の変換後単位が異なる場合はエラーとする。（変換後単位が異なっているということは、単位種類（重量、容量、長さ）が異なっているということであり、演算できない。ただし、この事態は発生しない想定である）
  4. 変換後数量を使って演算する。

- 「単位」を別の単位（単位種類は共通）に変換する場合は、以下の手順で行う。
  1. 度量衡マスターから、単位=指定単位のレコードと単位=変換後単位のレコードを取得する。
  2. 変換後数量 ← 指定数量 × 度量衡マスター（指定単位）.スケール ÷ 度量衡マスター（変換後単位）.スケール
- 度量衡マスターは値が固定の小さなマスターなので、ベンチマークアプリケーション内でキャッシュしてもよい。



## データ

度量衡マスターのデータは、固定値なので、別表の通りとする。

それ以外のデータは、ロジックに基づいて生成する。（件数を変化させられるようにするため）



バッチ実行で指定する日付を、データ生成時にもパラメーターとして指定するものとする。

有効日付範囲を持つテーブルの場合、レコード生成時の開始日・終了日は以下のように決定する。
開始日←パラメーターのバッチ日付 - ランダム[0..700]
終了日←パラメーターのバッチ日付 + ランダム[7..700]



### 工場マスター

工場数をパラメーターとして指定する。（想定件数は60件）

工場数パラメーターの数だけレコードを作成する。

- 工場ID
  - 1から連番
- 工場名
  - 「Factory」+工場ID



### 品目マスター・品目構成マスター

製品品目数、中間材品目数、原料品目数をパラメーターとして指定する。
★MEMO AN品目マスターの特定日の件数：製品7万2000、中間19万8000、原料7万5000、その他20万5000

品目構成マスターは品目の木構造となるため、品目マスターと同時に生成する。



#### 製品の品目マスター

指定されたレコード数の製品品目のデータを生成する。

- 品目ID
  - 1から連番
- 品目名
  - 「Bread」+品目ID
- 品目種類
  - 製品
- 単位
  - 個
- 重量比・重量単位
  - null



#### 原料の品目マスター

指定されたレコード数の原料品目のデータを生成する。

- 品目ID
  - `max(品目ID) + 1`
- 品目名
  - 「Material」+品目ID
    - 業務的には水・牛乳・油（容量系）、小麦粉・塩・砂糖・肉・野菜（重量系）、包装材・仕入れ品（数量系）等だが、ベンチマークアプリケーションとしては区別しない。
- 品目種類
  - 原料
- 単位
  - mL・cL・dL（容量系）・mg・cg・dg・g（重量系）・個（数量系）の中からランダムに選択
- 重量比・重量単位
  - 単位が容量系の場合
    - 重量比←1+ランダム[-0.10 .. 0.10]
    - 重量単位←単位がmLの場合はg、cLの場合はdag、dLの場合はhg
  - 単位が重量系の場合
    - 重量比←1
    - 重量単位←単位
  - 単位が数量系の場合
    - 重量比←ランダム[0.4 .. 500.0]
    - 重量単位←g
- 品目単価・品目単価単位
  - 単位が容量系の場合
    - 品目単価←ランダム[0.01 .. 2000.00]
    - 品目単価単位←L
  - 単位が重量系の場合
    - 品目単価←ランダム[0.01 .. 2000.00]
    - 品目単価単位←kg
  - 単位が数量系の場合
    - 品目単価←ランダム[0.01 .. 2000.00] ÷ 1000 × 重量比 （乱数値を1kg当たりの金額として換算する）
    - 品目単価単位←単位

#### 品目構成マスター

中間材の木構造を構築する。

木を作成し、そこから中間材の品目マスターおよび品目構成マスターを生成する。

全ての木の要素数が、パラメーターで指定された中間材品目数より少ない間、以下の処理を繰り返して木を作ってゆく。

ひとつの木は以下のように作成する。

1. 木の要素数を決定する。10+ランダム[-4 .. 4]個
   - それまでに作った要素と今回の要素の数の合計がパラメーターで指定された中間材品目数を超える場合は、要素数←中間材品目数 - それまでに作った要素数 とする。
2. ルート要素を作成する。
3. 木の要素数が最初に決定した値になるまで要素を追加していく。
   1. 木構造内の全ての要素からランダムに1要素を選択し、要素を1つ追加する。
4. 品目IDを割り当てる。
   1. ルート要素から順に深さ優先探索で品目IDを採番する。`max(品目ID) + 1`
   2. 中間材の品目マスターを生成する。
      - 品目ID
        - 採番した品目ID
      - 品目名
        - 「Process」+品目ID
      - 品目種類
        - 中間材
      - 単位・重量比・重量単位
        - null
5. 材料を割り当てる。
   1. 葉要素に対し、材料の品目マスターからランダム[1..3]個選択して追加する。
6. 葉要素に重量を割り当てる。
   1. ルート要素の重量としてランダム[20.0000 .. 100.0000]（単位：グラム）に決定する。
   2. 重量を子要素に対してランダムな割合で分割して割り当てる。
      再帰的に子要素に対して実施する。
7. 木構造のそれぞれの要素（ルート以外）に対し品目構成マスターを生成する。
   有効日付範囲は同じ木構造内では同じ値とする。
   - 品目ID
     - 該当要素の品目ID
   - 親品目ID
     - 親要素の品目ID
   - 原料単位、原料数量
     - 該当要素の品目が原料の場合のみ設定する（それ以外の場合はnull）
     - 原料単位←品目マスター.単位
     - 原料数量←上位から割り当てられた重量に対して品目マスター.重量比から逆算した値
   - ロス率
     - [0.00 .. 10.00]で0の方が出る確率が高い乱数値
       1. ランダム[0.00 .. 10.00]で値rを決める。
       2. ランダム[0.00 .. 10.00]で値sを決め、s≦10-rならr、それ以外なら10-rをロス率とする。



全ての木構造を作った後で、関連データを更新する。

1. 製品品目の品目構成マスターを生成する。
   1. 全ての製品品目IDに対し、中間材の品目マスターからランダム[1..5]個のレコードを選択し、品目構成マスターを生成する。（★TODO 全ての中間材から選ぶと、木としては大きいものも小さいものも混ざってしまう（乱数の試行毎にばらつきが出る））
      - 品目ID
        - 中間材の品目ID
      - 親品目ID
        - 製品の品目ID
      - 原料単位、原料数量
        - null
      - ロス率
        - [0.00 .. 10.00]で0の方が出る確率が高い乱数値



※上記の重量の計算式は、それらしい値を近似的に算出するためのものであり、実業務にこのような計算は無い。



#### 製造品目マスター

工場マスターの全工場IDに対して製造品目マスターを生成する。
以下のAとBの両方で品目IDを決定する。（基本的に工場毎にランダムに品目を割り当てるが、一部の品目については複数の工場に割り当てる）

A)
10製品は全ての工場で製造する。
20製品は50％の工場で製造する。（工場IDを2で割った余り＝1）
30製品は25％の工場で製造する。（工場IDを4で割った余り＝1）
40製品は10％の工場で製造する。（工場IDを10で割った余り＝1）
品目マスターの製品の中から品目IDが重複しないよう選択し、工場に割り当てる。

B)
パラメーターで指定された製造数になるまで割り当てを繰り返す。

- 工場ID
  - ランダムに決定した工場ID
- 品目ID
  - 割り当てられていない製品からランダムに選択した品目ID
- 生産数
  - ランダム[1..500]×100



#### 原価マスター

原料の品目マスターの全品目IDに対して原価マスターを生成する。

品目毎に、工場マスターの中から工場数の50％（★TODO 割合（ANでは1工場当たり何種類くらいの原料の在庫を持っているか？））をランダムに選択する。

- 工場ID、品目ID
  - 対象のID
- 在庫単位
  - 品目マスターの単位が重量の場合はkg、容量の場合はL、個数の場合は個
- 在庫数量
  - ランダム[1.0 .. 10.0]×100
- 在庫金額
  - 品目マスターの品目単価×ランダム[0.90 .. 1.10]×在庫数量（単位を共通化して計算する）



#### 結果テーブル

結果テーブルの全データを削除する。（初期化を複数回行う場合の考慮）



#### 有効日付範囲の増幅

有効日付範囲を持つ以下のテーブルに対し、レコード数の増幅を行う。

- 品目マスター3倍
- 品目構成マスター1.25倍
- 製造品目マスター1.6倍

ランダムで増幅元レコードを決定し、それに対して有効範囲日付を変更したレコードを追加でINSERTする。
新しい日付は、増幅元レコード（有効日付範囲以外のプライマリキーが同一の複数レコード（開始日で昇順））に対し、ランダムで日付的に前か後ろとする。

1. 前にINSERTする場合
   終了日←先頭レコード.開始日-1
   開始日←終了日-ランダム[1..700]
2. 後ろにINSERTする場合
   開始日←末尾レコード.終了日+1
   終了日←開始日+ランダム[1..700]

単純に乱数で値を決めたカラムに関しては、同じくランダムに値を決定する。それ以外のカラムは元となるレコードと同じ値とする。

※ここで増幅するレコードは、テーブル内のレコード数を増やすためのものであり、バッチ処理やオンライン処理では使用されないレコードである。
2021/9/28

benchmark1.mdを書くに当たって考慮している点



## テーブル定義

- 別工場で生産した品目、という構造は考えない。（ANにはある）

  - 別工場の処理結果を使用する場合は並列処理できないので、このような制約を入れようとしていたが、当ベンチマークのバッチ処理では結果テーブルに書くだけで読みはしない為、並列処理とは無関係。
  - また、ANの品目構成マスターと異なり、工場ごとに違う構成でもないので、特に気にする必要は無い。

  



## 初期データ作成

### 工場マスター

- ANの製造場所マスターは有効日付範囲を持っているが、当ベンチマークでは工場マスターは直接的にはほぼ使用しないので、有効日付範囲を除去した。



### 品目マスター

- ANには（製品・中間材・原料の他に）「その他」がけっこうな件数あるが、当ベンチマークでは扱わない。（その結果、想定件数がANの件数と離れてしまうが）
  - AN品目マスターの特定日の件数：製品7万2000、中間19万8000、原料7万5000、その他20万5000
- ANでは包装材は少し特別扱いしているようだが、当ベンチマークでは扱わない。
- 名称カラムの値は種類（製品・中間材・原料）の単語にIDを付加してるだけである。
  - 品目マスターは本来もっと細分化されてもいいと思うが、名前と容量の整合性をとるのが難しい。（品目構成の変更対象を既存品目から選択するなら、整合性のあるように決めるのはもっと難しい（ランダムに決めたら塩の代替に砂糖を使うようなことになってしまう））
    - 品目の種類を細分化するとしたら、どこまで？



### 品目構成マスター

- ★TODO 製品-中間材の品目構成を作る際に、完全にランダムに中間材を選んでいるが、これだと、木構造の深さがかなりばらついてしまう。中間材の木構造のルートから選択するようにした方がいいか？



### 製造品目マスター

- 工場間で重複する品目と重複しない品目を混ぜて生成する。
  - ★TODO 混ぜる割合はどのような値が適切か？（ANではそもそも工場毎に製造品目数が大きく異なる）



### 原価マスター

- ANには存在しないマスター。
- オンライン処理で在庫を減らしたり追加したりする度に原価マスターを更新するイメージだが、その処理と有効日付範囲の相性が悪い。（厳密にやりだせば、特定日の在庫を変更すればその日以降の在庫（原価）に影響が波及するはず→日付範囲でなく日付を持った方がいいかも）（バッチ実行日以外の日に対して複雑なデータ更新をしてもあまり意味が無い）



### 結果テーブル

- 初期データ作成時に、結果テーブルを全削除する。
  - オンライン処理で新しい品目が追加されると、バッチ処理でその品目が結果テーブルにも追加される。このため、再度初期化を行って品目マスターが初期状態に戻った際に結果テーブルをクリアしないと、品目が不整合になる。



### 初期データのINSERT順について

データの作成（INSERT）順について、どこまで考慮すべきか？

- 有効日付範囲を持つテーブルで、日付が異なるデータを増やすのは最後にまとめて行う。
  - 増幅が2倍とか3倍といったきりのよい数字であれば、個々のINSERT時点で日付の異なるデータを増やしてINSERTすればいいが、1.6倍のようにきりの悪い数字だと、増幅対象データを個々のINSERT時点で決めるのは無理があるため。（一旦全データをINSERTしてから、増幅対象データをランダムに1.6倍分選択することは出来る）
  - 問題点：最後にまとめて増幅させたデータは日付的に使われないデータとなる。RDBMSの内部実装的にまとめてINSERTしたデータは同じブロックに配置される可能性が高そうであり、使われないデータをINSERTしておいても実際にロードされないのであれば、あまり意味が無いかもしれない。
    - ベンチマーク実行を何度か行う場合、（オンライン処理によって）データが変わってしまっているので、実行前に元に戻す必要がある。バックアップテーブルから戻す場合、RDBMSの内部実装的に最初にINSERTしたのと異なる順で配置される可能性があり、それがベンチマークの測定結果に影響を及ぼすことがあるかも？



## バッチ処理

- 結果テーブルにDELETE-INSERTしている理由
  - 製造品目マスターから工場や品目が無くなった場合に結果テーブルから削除するため。
    この条件を満たすなら、既存データに対してupdateでもよい。（しかしDBの内部構造的にはたぶんupdateはdelete-insertなので、あえてupdateにする必要は無いと思う）
- 工場毎に品目をまとめてdeleteして品目毎にinsert-commitする場合、ある品目について、deleteされてからinsertされるまでに時間があく状態がありうる。が、これも許容せざるをえない。（業務トランザクション的には微妙だが、バッチの前提としてコミットタイミングは実装の自由としているため）



## オンライン処理

- バッチ処理が当日日付以外も処理するのでないと、オンライン処理で当日日付以外の日を更新するのはあまり意味が無い？
- ★TODO TPC-Cに倣ってスレッド毎に工場IDを固定という前提にしているが、想定工場数が60なので、スレッド数としては多くなってしまう？
  - 工場数が60でもスレッド数は10くらいにする？
  - 1スレッドが複数工場を扱う？
- ★TODO TPC-Cではオンライン処理の結果を画面に表示するが、当ベンチマークではログファイル出力ということでよいか？
  - 処理件数の把握とか、バッチの実行結果の検証にこのログを使う？



### 新規開発商品の追加

- 品目IDの採番方法について
  - 案：max(品目ID)+1とする
    - 品目マスターのPKに有効日付範囲があると、新品目を別スレッドで同時に採番した際に開始日が異なると一意制約違反にならない。
      - 解決案：開始日を常に同じ値（当日）にする
        - ベンチマーク測定中に日をまたぐとダメ
          - 「当日」はシステム日付でなく引数とすればよい
      - 解決案：ロックテーブルを使用（品目IDの採番用）
        - あまりロックテーブルは使いたくない
      - 解決案：有効日付範囲をやめる
        - マスターに有効日付範囲があるのはよくあることなので、あった方が良い
      - 解決案：新品目を作る処理は1スレッドのみとする
        - ベンチマーク的に微妙
    - max(品目ID)+1方式だと、一意制約違反時にロールバックというパターンが出来る。
  - 案：Oracleシーケンスで採番する
    - 初期データ作成時にmax(品目ID)+1で採番しているので、シーケンスと値を合わせるのは難しい（出来なくはないはずだけど、トリッキー）
      - 初期データ作成時もシーケンスを使えばいい（その方が並列でデータを作れる）
    - シーケンスが無いRDBMSだとやっかい



### 生産数の変更

- 業務的には1品目ずつ更新していきそうだが、工場内全件一括更新（コミット）にした方が、データがバッチと重なりやすいと思われる。

- 生産数を0にするときは製造品目マスターのdelete
  - 0のときにupdateでも処理全体として問題は無いが、オンライン処理でdeleteというパターンを作りたい。
- 更新対象の製造品目マスターの日付もランダムにした方がいいかもしれないが、未来日付のレコードを更新してもバッチ処理に無関係。
- 更新対象の製造品目マスターの開始日が過去日だった場合、レコード分割して当日以降を更新した方が業務らしい（過去の生産数は変更しない）かもしれないが、そこまでやる必要はあるか？



### 原材料の変更

- 変更先品目IDを既存の品目IDから（ランダムに）選んで更新する場合、品目構成マスターの木構造が狂って循環してしまう可能性がある。そこさえクリアできれば、品目を追加するより良い。



### 原価の変更

- 変更対象を品目マスターから選択し、原価マスターに無い場合はINSERTということも考えられる。が、パターンとしては生産数の変更と全く同じになってしまう。



### 重量の照会

- 品目の重量は工場が異なっても同じ値のはずなので、selectする際にdistinctする方法でも良さそうに思えるが、品目構成マスターを更新してバッチを実行している最中は異なる重量になる可能性もあるので、distinctだと駄目。
- selectする際の工場IDはどれでもいいが、オンライン処理を実行するスレッドで工場IDは固定という前提があるので、その工場IDを使う。



----

- ★TODO オンライン処理の検証は、SQLの対話型ツールでSQLを実行していけば（ステップ実行のイメージ）検証できると思われる。
  しかしバッチ処理の検証はどうするか？
  - オンライン処理でログ出力する？とすれば、そのログをバッチの実行結果の検証に使えるか？
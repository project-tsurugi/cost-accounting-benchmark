# サンプルバッチの仕様

本ドキュメントは、バッチの実行中に常にWriteが発生するタイプのバッチの
サンプルとして作成する電話料金計算バッチの仕様について記述する。


## テーブル仕様

* 通話履歴
  - 発信者電話番号(PK)
  - 受信者電話番号
  - 料金区分(発信者負担、受信社負担)
  - 通話開始時刻(PK)
  - 通話時間
  - 通話料金
  - 論理削除フラグ

* 契約マスタ
  - 電話番号(PK)
  - 契約開始日(PK)
  - 契約終了日(NULLあり->契約中で解約の予定がない場合)
  - 料金計算ルール(詳細後述)

* 月額利用料金
  - 電話番号(PK)
  - 対象年月(PK)
  - 基本料金
  - 通話料金
  - 請求金額

## データ量とデータサイズ

* 各テーブルには、バッチサーバのメモリに乗らない大きさのデータが格納されている
* データサイズは、テストに使用するサーバのスペックや、テストの効率を考えて別途規定する。
* テストデータ作成時に必要となる諸元についても別途設定する
* 例:
  - 契約マスタ
    * 過去1年分のデータを保持
    * 1000万レコード
    * 契約開始日が異なる同一の電話番号のレコードが全体の1%程度
    * 契約終了日が存在するレコードが50%, そのうち10%が未来日付
  - 通話履歴
    * 過去1年分のデータを保持
    * 1契約に対して、1日あたり平均1回の通話がある
    * 通話回数は対数正規分布に従う
  - 月額利用料金
    * 過去1年分のデータを保持


## バッチ処理概要

* パラメータとして料金計算対象の年月が与えられる
* 契約マスタから、当該年月に有効な契約があるレコードを抽出する
* 抽出した各レコードに対して以下の処理を繰り返す
  - 通話履歴テーブルから、料金計算対象のレコードの値を取り出す(SELECT FOR UPDATE)
   * 発信者電話番号が契約マスタの電話番号で同じで、料金区分が発信者負担
   * 受信者電話番号が契約マスタの電話番号で同じで、料金区分が受信者負担
   * 通話開始時刻が、契約マスタの契約開始日～契約終了日の間
  - 料金計算ルール(後述)に従い料金を計算し、通信履歴テーブルの通話料金を更新する(UPDATE)
  - 料金計算ルール(後述)に従い、月額利用料金を更新する(INSERT OR UPDATE)
* バッチ全体を1トランザクションとする
   
## 料金計算ルール

* 以下のルールがマスタに記録されている。
* DB上のルールの持ち方については別途検討。

### 一通話の料金の計算

* 契約毎に決められた単価 
  - X 秒 当たり Y円
  - Xは10, 20, 30, 60 のいずれか
  - Yは10, 20のいずれか
* 契約毎に決められた例外計算
  - 指定の電話番号への通話は無料
    * 最大3つ指定可能
  - 指定の時間まで無料
    * 5分以内は無料

### 月額料金

* 基本料金
  - 1000円, 2000円, 3000円のいずれか
* 利用料金は当該年月の一通話の料金の和
* 請求金額は基本料金 + 通話料金、ただし以下の例外計算がある
  - 料金計算年月に契約開始日または契約終了日が含まれている場合、基本料金を日割り計算する。
  - 基本料金に通話料金の無料分が含まれているケース
    * 無料料金は基本料金の 50% または 80%
    * 基本料金を日割り計算した場合、無料分も日割り計算する
  - ボリュームディスカウント(契約によりある場合がある)
    * 無料分を除く料金が x 円以上の場合、 x円を超える料金を y %引きとする。
    * x は 1万, 2万, 5万のいずれか
    * y は、10, 20, 30のいずれか
    * 一つの契約に複数のボリュームディスカウントがつくことがある

## バッチ実行時に発生する可能性があるトランザクション

* 月額利用料金テーブルは参照のみ、更新はなし
* 契約マスタ
  - 常にINSERTされる可能性がある
    * INSERT時に全項目に値が設定される
  - 電話番号以外の項目はUPDATEされる可能性がある
  - 論理削除される可能性がある
* 通話履歴
  - 常にINSERTされる可能性がある
    * INSERT時に通話料金以外の全項目に値が設定される
  - 電話番号以外の項目はUPDATEされる可能性がある
  - 論理削除される可能性がある
